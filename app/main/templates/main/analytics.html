{% extends "base.html" %}

{% block title %}Analytics{% endblock %}

{% block content %}
    <h1>Analytics</h1>
    {% if gpa is not none %}
    <p><strong>GPA:</strong> {{ gpa }}</p>
    {% else %}
    <p><em>GPA: N/A (no graded submissions yet)</em></p>
    {% endif %}

    {% if assignments_data and assignments_data|length > 0 %}
    <div>
        {% for ad in assignments_data %}
        <div style="margin-bottom: 24px;">
            <h3>{{ ad.assignment_title }} <span class="muted">({{ ad.course_title }})</span></h3>
            <div style="display:flex; gap: 16px; align-items:center;">
                <div>
                    <canvas id="chart-{{ ad.assignment_id }}" width="480" height="240"></canvas>
                </div>
                <div>
                    <div><strong>Highest:</strong> {{ ad.high if ad.high is not none else '—' }}</div>
                    <div><strong>Lowest:</strong> {{ ad.low if ad.low is not none else '—' }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No assignments found for analytics.</p>
    {% endif %}

    <!-- For analytics, we chose to use Chart.js, which uses some Javascript to create animated graphs-->
    <!-- We followed Chart.js documentation and a YT video: https://www.youtube.com/watch?v=PKXYUtOs3RE -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
    // Convert Python data to JavaScript - assignments_data contains all assignment analytics
    const analyticsData = {{ assignments_data | tojson }};
    
    // Loop through each assignment and create a chart for it
    analyticsData.forEach(ad => {
        const ctx = document.getElementById(`chart-${ad.assignment_id}`); // Canvas context for Chart.js
        if (!ctx) return; // Skip if canvas not found
        
        // Define x-axis labels
        const labels = ['Student', 'Class Avg'];
        
        // Define data points: student score and class average
        const dataPoints = [ad.student_score ?? null, ad.class_avg ?? null]; 

        new Chart(ctx, {
            type: 'bar', // Chart type: bar graph
            data: {
                labels, 
                datasets: [{
                    label: `${ad.assignment_title}`, // Dataset label (assignment name)
                    data: dataPoints, // Y-axis values [student score, class avg]
                    backgroundColor: ['#4CAF50', '#2196F3'], // Green for student, blue for class avg
                    borderRadius: 4 // Rounded corners on bars
                }]
            },
            options: {
                responsive: true, // Auto-resize chart on window resize
                scales: {
                    y: {
                        beginAtZero: true, // Y-axis starts at 0
                        max: 100, // Maximum score is 100%
                        title: { display: true, text: 'Score (%)' } // Y-axis label
                    }
                },
                plugins: {
                    legend: { display: false }, // disable hiding legend
                    tooltip: {
                        callbacks: {
                            // Customize tooltip text when hovering over bars
                            // ctx = tooltip context with dataset info
                            label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y ?? 'N/A'}%`
                        }
                    }
                }
            }
        });
    });
    </script>
{% endblock %}